name: CD - Main Branch

on:
  workflow_run:
    workflows: ["CI - Main Branch"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    # CIê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì»¤ë°‹ ID ì¶”ì¶œ (6ìë¦¬)
        id: commit
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-6)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Commit ID (short): $SHORT_SHA"

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: hojipkim/everp_scm
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.commit.outputs.short_sha }}
            type=sha,prefix=,format=short

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            hojipkim/everp_scm:latest
            hojipkim/everp_scm:${{ steps.commit.outputs.short_sha }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: ë°°í¬ ì •ë³´ ì¶œë ¥
        run: |
          echo "========================================="
          echo "Docker ì´ë¯¸ì§€ ë°°í¬ ì™„ë£Œ"
          echo "========================================="
          echo "ì´ë¯¸ì§€: hojipkim/everp_scm"
          echo "íƒœê·¸ 1: latest"
          echo "íƒœê·¸ 2: ${{ steps.commit.outputs.short_sha }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo "========================================="

  notify:
    name: CD ê²°ê³¼ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: CD ê²°ê³¼ ì„¤ì •
        id: cd-result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "status=ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "emoji=ğŸš€" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "status=ê±´ë„ˆëœ€ (CI ì‹¤íŒ¨)" >> $GITHUB_OUTPUT
            echo "emoji=â­ï¸" >> $GITHUB_OUTPUT
          else
            echo "status=ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi

      - name: ì»¤ë°‹ ID ì¶”ì¶œ
        id: commit
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-6)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Slack ì•Œë¦¼ ì „ì†¡
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "Main ë¸Œëœì¹˜ CD ${{ steps.cd-result.outputs.status }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.cd-result.outputs.emoji }} Main ë¸Œëœì¹˜ CD ${{ steps.cd-result.outputs.status }}",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ì €ì¥ì†Œ:*\n${{ github.repository }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ë¸Œëœì¹˜:*\n`main`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ì»¤ë°‹:*\n`${{ github.sha }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Docker ì´ë¯¸ì§€:*\n`hojipkim/everp_scm`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*íƒœê·¸:*\n`latest`, `${{ steps.commit.outputs.short_sha }}`"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${{ needs.deploy.result == 'success' && 'âœ… Docker Hubì— ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤.' || needs.deploy.result == 'skipped' && 'â­ï¸ CI ì‹¤íŒ¨ë¡œ ì¸í•´ CDê°€ ê±´ë„ˆë›°ì–´ì¡ŒìŠµë‹ˆë‹¤.' || 'âŒ Docker ì´ë¯¸ì§€ í‘¸ì‹œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ì›Œí¬í”Œë¡œìš° ë³´ê¸°"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "Docker Hub ë³´ê¸°"
                    },
                    "url": "https://hub.docker.com/r/hojipkim/everp_scm"
                  }
                ]
              }
            ]
          }'
